---
title: "闭包"
description: "通过计数器、私有变量、setTimeout 循环、工厂函数、记忆函数、模块模式、DOM 事件与 once 等示例，系统理解闭包的能力与常见用法。"
publishDate: "2025-07-24"
tags: ["JavaScript", "闭包", "作用域", "函数式编程"]
draft: false
---
# 闭包示例
---
## **✅ 1. 计数器（经典闭包例子）**
```JavaScript
function createCounter() {
  let count = 0;
  return function () {
    count++;
    return count;
  };
}
const counter = createCounter();
console.log(counter()); // 1
console.log(counter()); // 2
console.log(counter()); // 3
```

> 函数 counter 保留了对 count 的引用。
---
## **✅ 2. 私有变量封装**
```JavaScript
function User(name) {
  let _password = 'secret';
  return {
    getName() {
      return name;
    },
    checkPassword(pwd) {
      return pwd === _password;
    }
  };
}
const user = User("Alice");
console.log(user.getName()); // "Alice"
console.log(user.checkPassword("secret")); // true
console.log(user._password); // undefined ❌ 外部访问不到
```

> _password 是私有变量，通过闭包保持作用域。
---
## **✅ 3. 延迟执行 &**
## **setTimeout**
## **循环闭包问题**
### **❌ 错误写法：**
```JavaScript
for (var i = 0; i < 3; i++) {
  setTimeout(() => console.log(i), 1000);
}
// 输出：3 3 3
```
### **✅ 正确闭包方式：**
```JavaScript
for (var i = 0; i < 3; i++) {
  (function (j) {
    setTimeout(() => console.log(j), 1000);
  })(i);
}
// 输出：0 1 2
```
或者用 let（块作用域）也可以：
```JavaScript
for (let i = 0; i < 3; i++) {
  setTimeout(() => console.log(i), 1000);
}
```
---
## **✅ 4. 工厂函数**
```JavaScript
function multiplier(factor) {
  return function(x) {
    return x * factor;
  };
}
const double = multiplier(2);
console.log(double(5)); // 10
```

> double 保留了 factor=2 的闭包。
---
## **✅ 5. 缓存函数（记忆函数）**
```JavaScript
function memoize(fn) {
  const cache = {};
  return function(n) {
    if (n in cache) {
      return cache[n];
    } else {
      const result = fn(n);
      cache[n] = result;
      return result;
    }
  };
}
const square = memoize(n => n * n);
console.log(square(5)); // 25（计算）
console.log(square(5)); // 25（读取缓存）
```
---
## **✅ 6. 模拟私有方法（模块模式）**
```JavaScript
const Counter = (function() {
  let count = 0;
  return {
    increment() {
      count++;
    },
    getCount() {
      return count;
    }
  };
})();
Counter.increment();
Counter.increment();
console.log(Counter.getCount()); // 2
```
---
## **✅ 7. DOM 事件处理中的闭包**
```JavaScript
function setupButton(id) {
  let clicked = false;
  document.getElementById(id).addEventListener("click", function () {
    if (!clicked) {
      console.log("Button clicked!");
      clicked = true;
    } else {
      console.log("Already clicked.");
    }
  });
}
```

> clicked 被闭包捕获，记住每个按钮是否点过。
---
## **✅ 8. 实现 once 函数（只执行一次）**
```JavaScript
function once(fn) {
  let called = false;
  let result;
  return function(...args) {
    if (!called) {
      result = fn.apply(this, args);
      called = true;
    }
    return result;
  };
}
const init = once(() => {
  console.log("初始化执行！");
  return 42;
});
init(); // 输出 "初始化执行！"
init(); // 不再执行，只返回结果
```
---
---
